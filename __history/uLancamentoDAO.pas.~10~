unit uLancamentoDAO;

interface

uses
  uLancamento, uConexao, System.SysUtils, FireDAC.Comp.Client, FireDAC.Stan.Param,
  FireDAC.DApt, uUtils, System.Generics.Collections, Vcl.Dialogs;

type
  TLancamentoDAO = class
  public
    function BuscarLancamentos: TObjectList<TLancamento>;
    procedure InserirLancamento(const ALancamento: TLancamento);
  end;

implementation

function TLancamentoDAO.BuscarLancamentos: TObjectList<TLancamento>;
var
  ResultSet: TObjectList<TLancamento>;
  Lancamento: TLancamento;
  Qry: TFDQuery;
begin
  Result := nil;
  Qry := TFDQuery.Create(nil);
  ResultSet := TObjectList<TLancamento>.Create(False);
end;

procedure TLancamentoDAO.InserirLancamento(const ALancamento: TLancamento);
var
  Qry: TFDQuery;
begin
  Qry := TFDQuery.Create(nil);

  try
    try
      Qry.Connection := dmConexao.FDConnection;
      // SQL para inserir o novo lançamento
      Qry.SQL.Text := 'INSERT INTO lancamentos (categoria, tipo, descricao, valor, data, observacoes, entidade) VALUES' +
      '(:categoria, :tipo, :descricao, :valor, :data, :observacoes, :entidade)';

      // Define as propriedades do lançamento como parâmetro pro insert
      Qry.ParamByName('categoria').AsInteger := ALancamento.CategoriaID;
      Qry.ParamByName('tipo').AsString := CatToStr(ALancamento.Tipo);
      Qry.ParamByName('descricao').AsString := ALancamento.Descricao;
      Qry.ParamByName('valor').AsFloat := ALancamento.Valor;
      Qry.ParamByName('data').AsDate := ALancamento.Data;
      Qry.ParamByName('observacoes').AsString := ALancamento.Observacoes;
      qry.ParamByName('entidade').AsString := ALancamento.Entidade;

      // Executa a query
      Qry.ExecSQL;

      // Recupera o ID do lançamento inserido e grava no objeto
      ALancamento.ID := Qry.Connection.ExecSQLScalar('SELECT LAST_INSERT_ID()');
    except
        on E: Exception do
        ShowMessage(E.Message);
    end;
  finally
    Qry.Free;
  end;
end;

end.
